{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  {% if messages %}
  <div class="messages-container mb-4">
    {% for message in messages %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="card shadow">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
      <h5 class="mb-0 text-primary fw-bold">Gestion des Stocks</h5>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary btn-sm" onclick="window.print()">
          <i class="bi bi-printer me-1"></i>Imprimer
        </button>
      </div>
    </div>
    
    <!-- Statistiques des stocks -->
    <div class="card-body border-bottom">
      <div class="row row-cols-1 row-cols-md-5 g-4 mb-4">
        <div class="col">
          <div class="card bg-primary text-white h-100">
            <div class="card-body">
              <h6 class="card-title">Total Produits</h6>
              <h2 class="card-text mb-0">{{ total_produits }}</h2>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card bg-success text-white h-100">
            <div class="card-body">
              <h6 class="card-title">En Stock (disponibles)</h6>
              <h2 class="card-text mb-0">{{ nb_en_stock_disponible }}</h2>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card bg-warning text-white h-100">
            <div class="card-body">
              <h6 class="card-title">Stock Limité (disponibles)</h6>
              <h2 class="card-text mb-0">{{ nb_limite_disponible }}</h2>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card bg-danger text-white h-100">
            <div class="card-body">
              <h6 class="card-title">En Rupture</h6>
              <h2 class="card-text mb-0">{{ nb_rupture }}</h2>
            </div>
          </div>
        </div>
      <!-- Pagination -->
      {% if is_paginated %}
      <nav aria-label="Pagination des stocks" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Précédent">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
          {% endif %}
          {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Suivant">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
        <div class="col">
          <div class="card bg-dark text-white h-100">
            <div class="card-body">
              <h6 class="card-title">Produits Expirés</h6>
              <h2 class="card-text mb-0">{{ nb_expire }}</h2>
            </div>
          </div>
        </div>
      </div>

      <!-- Barre de recherche et filtres -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Rechercher un produit...">
          </div>
        </div>
        <div class="col-md-8 text-end">
          <div class="btn-group">
            <a href="?" class="btn btn-outline-primary {% if not filtre_statut_exp and not filtre_produit %}active{% endif %}">Tous</a>
            <a href="?statut_exp=valide&statut_q=green" class="btn btn-outline-success {% if request.GET.statut_q == 'green' %}active{% endif %}">En stock</a>
            <a href="?statut_exp=valide&statut_q=orange" class="btn btn-outline-warning {% if request.GET.statut_q == 'orange' %}active{% endif %}">Stock limité</a>
            <a href="?statut_exp=valide&statut_q=red" class="btn btn-outline-danger {% if request.GET.statut_q == 'red' %}active{% endif %}">Rupture</a>
          </div>
        </div>
      </div>

      <!-- Filtres rapides Expiré/Disponible -->
      <div class="row g-3 mb-4">
        <div class="col-md-12 text-end">
          <div class="btn-group">
            <a href="?statut_exp=expire" class="btn btn-danger {% if filtre_statut_exp == 'expire' %}active{% endif %}"><i class="bi bi-exclamation-octagon me-1"></i> Expirés</a>
            <a href="?statut_exp=valide" class="btn btn-success {% if filtre_statut_exp == 'valide' or not filtre_statut_exp %}active{% endif %}"><i class="bi bi-check-circle me-1"></i> Disponibles</a>
          </div>
        </div>
      </div>
      <!-- Formulaire de filtre avancé (masqué pour simplifier l'UX) -->
      <form method="get" class="row g-3 align-items-end mb-4 d-none" id="filtreForm">
        <div class="col-md-4">
          <label for="filtre_statut_expiration" class="form-label mb-1">Statut d'expiration</label>
          <select name="statut_expiration" id="filtre_statut_expiration" class="form-select filtre-auto">
            <option value="">Tous</option>
            <option value="valide" {% if filtre_statut_expiration == 'valide' %}selected{% endif %}>Valide</option>
            <option value="proche" {% if filtre_statut_expiration == 'proche' %}selected{% endif %}>Proche expiration</option>
            <option value="expire" {% if filtre_statut_expiration == 'expire' %}selected{% endif %}>Expiré</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="filtre_produit" class="form-label mb-1">Produit</label>
          <select name="produit" id="filtre_produit" class="form-select filtre-auto">
            <option value="">Tous</option>
            {% for produit in produits %}
              <option value="{{ produit.pk }}" {% if filtre_produit == produit.pk|stringformat:'s' %}selected{% endif %}>{{ produit }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4 d-none">
          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel me-1"></i>Filtrer</button>
        </div>
      </form>
    </div>
    
    <div class="card-body">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th scope="col">Produit <i class="bi bi-arrow-down-up text-muted ms-1"></i></th>
            <th scope="col">Statut & Quantité <i class="bi bi-arrow-down-up text-muted ms-1"></i></th>
            <th scope="col">Prix <i class="bi bi-arrow-down-up text-muted ms-1"></i></th>
            <th scope="col">Lot <i class="bi bi-arrow-down-up text-muted ms-1"></i></th>
            <th scope="col">Date d'expiration</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for x in object_list %}
          <tr data-status="{% if x.statut_quantite == 'green' %}en-stock{% elif x.statut_quantite == 'orange' %}limite{% else %}rupture{% endif %}">
            <td>
              <div class="d-flex align-items-center">
                <div>
                  <h6 class="mb-0">{{ x.produit }}</h6>
                  
                </div>
              </div>
            </td>
            <td>
              <div class="d-flex align-items-center">
                {% if x.statut_quantite == 'green' %}
                <span class="badge bg-success me-2">En stock</span>
                {% elif x.statut_quantite == 'orange' %}
                <span class="badge bg-warning me-2">Stock limité</span>
                {% else %}
                <span class="badge bg-danger me-2">Rupture</span>
                {% endif %}
                <strong>{{ x.quantite }}</strong>
              </div>
            </td>
            
            <td>{{ x.prix_achat }} Fbu</td>
            <td>{{ x.lot }}</td>
            <td>
              <span class="fw-bold">{{ x.date_expiration|date:"d/m/Y" }}</span>
              {% if x.statut_expiration == 'expire' %}
                <span class="badge bg-danger ms-1">Expiré</span>
              {% elif x.statut_expiration == 'proche' %}
                <span class="badge bg-warning text-dark ms-1">Proche expiration</span>
              {% else %}
                <span class="badge bg-success ms-1">Valide</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exampleModal-{{ x.pk }}" title="Détails">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- Modal Détails -->
          <div class="modal fade" id="exampleModal-{{ x.pk }}" tabindex="-1" aria-labelledby="exampleModalLabel-{{ x.pk }}" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title fw-bold" id="exampleModalLabel">Détails du produit: {{ x.produit }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row g-4">
                    <div class="col-md-6">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="card-subtitle mb-2 text-muted">Informations générales</h6>
                          <dl class="row mb-0">
                            <dt class="col-sm-4">Produit</dt>
                            <dd class="col-sm-8">{{ x.produit }}</dd>
                            <dt class="col-sm-4">Prix</dt>
                            <dd class="col-sm-8">{{ x.prix_achat }} Fbu</dd>
                            <dt class="col-sm-4">Quantité</dt>
                            <dd class="col-sm-8">{{ x.quantite }}</dd>
                            <dt class="col-sm-4">Statut</dt>
                            <dd class="col-sm-8">
                              {% if x.statut_quantite == 'green' %}
                              <span class="badge bg-success">En stock</span>
                              {% elif x.statut_quantite == 'orange' %}
                              <span class="badge bg-warning">Stock limité</span>
                              {% else %}
                              <span class="badge bg-danger">Rupture de stock</span>
                              {% endif %}
                            </dd>
                            <dt class="col-sm-4">Statut expiration</dt>
                            <dd class="col-sm-8">
                              {% if x.statut_expiration == 'expire' %}
                                <span class="badge bg-danger">Expiré</span>
                              {% elif x.statut_expiration == 'proche' %}
                                <span class="badge bg-warning text-dark">Proche expiration</span>
                              {% else %}
                                <span class="badge bg-success">Valide</span>
                              {% endif %}
                            </dd>
                          </dl>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="card-subtitle mb-2 text-muted">Dates & Description</h6>
                          <dl class="row mb-0">
                            <dt class="col-sm-4">Date d'ajout</dt>
                            <dd class="col-sm-8">{{ x.date_ajout|date:"d/m/Y" }}</dd>
                            <dt class="col-sm-4">Date d'expiration</dt>
                            <dd class="col-sm-8">{{ x.date_expiration|date:"d/m/Y" }}</dd>
                            <dt class="col-sm-4">Lot</dt>
                            <dd class="col-sm-8">{{ x.lot }}</dd>
                            <dt class="col-sm-4">Conditionnement</dt>
                            <dd class="col-sm-8">{{ x.condisionnement }}</dd>
                            <dd class="col-sm-8">{{ x.conditionnement }}</dd>
                            
                          </dl>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .table th {
    font-weight: 600;
    white-space: nowrap;
  }
  .modal-content {
    border: none;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  .messages-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 280px;
  }
  .btn-sm {
    padding: 0.25rem 0.5rem;
  }
  .badge {
    font-weight: 500;
  }
  .stats-card {
    transition: all 0.3s ease;
  }
  .stats-card:hover {
    transform: translateY(-5px);
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Recherche
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('keyup', function() {
          const searchText = this.value.toLowerCase();
          const rows = document.querySelectorAll('tbody tr');
          rows.forEach(row => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(searchText) ? '' : 'none';
          });
      });
    }

    // Filtres
    const filterButtons = document.querySelectorAll('[data-filter]');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            const rows = document.querySelectorAll('tbody tr');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            rows.forEach(row => {
                if (filter === 'all' || row.getAttribute('data-status') === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });

    // Auto-filtrage sur changement des filtres avancés
    var selects = document.querySelectorAll('.filtre-auto');
    selects.forEach(function(select) {
        select.addEventListener('change', function() {
            document.getElementById('filtreForm').submit();
        });
    });

    // Auto-fermeture des alertes
    setTimeout(function() {
        var alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            var bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 3000);
});
</script>
{% endblock %}